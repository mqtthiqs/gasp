\begin{figure}
\boxed{
\whnf{\tyenv}{\term}{\type}{\spine}{\listof\adef}{\term}
}
\begin{center}
\begin{mathpar}
\infer{
\whnf{\tenvcons{\tyenv}{\xadef{\var}{\head'}{\type}}}
     {\term}
     {\typebis}
     {{\spine}'}
     {\listof\adef}
     {\term}
}{
\whnf{\tyenv}
     {\tlam{\bind\var\promise\type}{\term}}
     {\typrod{\bind{\var}{\promise}{\type}}{\typebis}}
     {\head'{\spine}'}
     {\xadef{\var}{\head'}{\type}\listof\adef}
     {\term}
}

\infer{
\wellsharedhead{\tyenv}{\head'}{\promise'}{\pretype} \\
\subpretype{\pretype}{\erase{\type}}\\\\
\whnf{\tenvcons{\tyenv}{\xadef{\var}{\head'}{\type}}}
     {\tapp{\head}{\concat{\spine}{\var}}}
     {\typebis}
     {{\spine}'}
     {\listof\adef}
     {\term}
}{
\whnf{\tyenv}
     {\tapp{\head}{\spine}}
     {\typrod{\bind{\var}{\promise}{\type}}{\typebis}}
     {\head'{\spine}'}
     {\xadef{\var}{\head'}{\type}\listof\adef}
     {\term}
}

\infer{
\wellsharedhead{\tyenv}{\head'}{\promise'}{\pretype} \\
\tenvlookup{\tyenv}{\var} = (\oftype{\term}{\type}) \\\\
\whnf{\tyenv}
     {\term}
     {\type}
     {\spine \head' {\spine}'}
     {\listof\adef}
     {\term}
}{
\whnf{\tyenv}
     {\tapp{\var}{\spine}}
     {\typebis}
     {\head'{\spine}'}
     {\listof\adef}
     {\term}
}

\infer{
}{
\whnf{\tyenv}
     {\tapp{\head}{\spine}}
     {\type}
     {\emptylist}
     {\emptylist}
     {\tapp{\head}{\spine}}
}

\infer{
}{
\whnf{\tyenv}
     {\tlam{\binding}{\term}}
     {\type}
     {\emptylist}
     {\emptylist}
     {\tlam{\binding}{\term}}
}

\infer{
\openscope{\tyenv}{\tenvlookup{\tyenv}{\var}}{\listof\adef} \\
\whnf{\tenvcons{\tyenv}{\listof\adef}}
     {\term}
     {\type}
     {\spine}
     {{\listof\adef}'}
     {\term}
}{
\whnf{\tyenv}
     {\topen{\term}{\var}}
     {\type}
     {\spine}
     {\listof\adef{\listof\adef}'}
     {\term}
}

\infer{
\whnf{\tenvcons{\tyenv}{\listof\adef}}
     {\term}
     {\type}
     {\spine}
     {{\listof\adef}'}
     {\term}
}{
\whnf{\tyenv}
     {\tdef{\listof\adef}{\term}}
     {\type}
     {\spine}
     {\listof\adef{\listof\adef}'}
     {\term}
}
\end{mathpar}
\end{center}
\caption{Weak head normalization with precautious expansion of definitions.}
\end{figure}
