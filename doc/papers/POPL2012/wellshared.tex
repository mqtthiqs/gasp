\begin{figure}
\boxedtitle{
\wellsharedterm{\tyenv}{\term}{\pretype}
}
\begin{center}
\begin{mathpar}
\infer{
\wellsharedhead{\tyenv}{\head}{\pused}{\pretype_1}\\\\
\wellsharedspine{\tyenv}{\pretype_1}{\spine}{\pretype_2}
}{
\wellsharedterm{\tyenv}{\tapp{\head}{\spine}}{\pretype_2}
}

\infer
{
\wellsharedterm{\tenvbind\tyenv{\var}{\promise}{\type}}
               {\term}
               {\pretype}
}{
\wellsharedterm{\tyenv}
               {\tlam{\bind{\var}{\promise}{\type}}{\term}}
               {\ptarrow{\erase{\type}}{\promise}{\pretype}}
}

\infer{
\wellsharedadefs{\tyenv}{\spine} \\\\
\wellsharedterm{\tenvcons{\tyenv}{\spine}}{\term}{\sigma}
}{
\wellsharedterm{\tyenv}{\tdef{\spine}{\term}}{\sigma}
}

\infer{
\openscope{\tyenv}{\tenvlookup{\tyenv}{\var}}{\spine}\\\\
\wellsharedterm{\tenvcons{\tyenv}{\spine}}{\term}{\sigma}
}{
\wellsharedterm{\tyenv}{\topen{\term}{\var}}{\sigma}
}
\end{mathpar}
\end{center}


\boxedtitle{
\wellsharedhead{\tyenv}{\head}{\promise}{\pretype}
}
\begin{center}
\begin{mathpar}
\infer{
\tenvlookup{\tyenv}{\var} = \bind{\var}{\promise}{\type}
}{
\wellsharedhead{\tyenv}{\var}{\promise}{\erase{\type}}
}

%
% J'ai l'impression que l'on peut sans risque affirmer
% qu'une définition est toujours utilisable. En effet,
% si on avait un alias de la forme :
%       fun (x :_unused A). (y = x) in y
% alors la définition [y = x] serait mal typée.
% Cela briserait l'invariant que les environnements 
% ne contiennent que des définitions bien typées par
% ce système. 
\infer{
\tenvlookup{\tyenv}{\var} = (\oftype{\term}{\type})
}{
\wellsharedhead{\tyenv}{\var}{\pused}{\erase{\type}}
}

\infer{
}{
\wellsharedhead{\tyenv}{\constant}{\pused}{\erase{\type}}
}
\end{mathpar}
\end{center}

\boxedtitle{
\wellsharedspine{\tyenv}{\pretype}{\spine}{\pretype}
}
\begin{center}
\begin{mathpar}
\infer{
}{
\wellsharedspine{\tyenv}{\pretype}{\emptylist}{\pretype}
}

\infer{
\wellsharedhead{\tyenv}{\head}{\promise_2}{\pretype_1'} \\\\
\promise_1 \leq \promise_2 \\
\subpretype{\pretype_1'}{\pretype_1}
}{
\wellsharedspine{\tyenv}{\ptarrow{\pretype_1}{\promise_1}{\pretype_2}}
                {\head\spine}
                {\pretype_3}
}
\end{mathpar}
\end{center}

\boxedtitle{
\wellsharedadefs{\tyenv}{\adefs}
}
\begin{center}
\begin{mathpar}
\infer{
}{
\wellsharedadefs{\tyenv}{\emptylist}
}

\infer{
\wellsharedterm{\tyenv}{\term}{\erase{\type}}\\
\wellsharedadefs{\tenvdef{\tyenv}{\var}{\type}{\term}}{\adefs}
}{
\wellsharedadefs{\tyenv}{\xadef{\var}{\type}{\term}\adefs}
}
\end{mathpar}
\end{center}

\boxedtitle{
\wellsharedtype{\tyenv}{\type}
}
\begin{center}
\begin{mathpar}
\infer{
\wellsharedtype{\tenvcons\tyenv\binding}{\type}
}{
\wellsharedtype{\tyenv}{\typrod{\binding}{\type}}
}

\infer{
\wellsharedadefs{\tyenv}{\adefs} \\\\
\wellsharedtype{\tenvcons{\tyenv}{\adefs}}{\type}
}{
\wellsharedtype{\tyenv}{\tydef{\adefs}{\type}}
}

\infer{
\openscope{\tyenv}{\tenvlookup{\tyenv}{\var}}{\spine}\\\\
\wellsharedtype{\tenvcons\tyenv{\spine}}{\type}
}{
\wellsharedtype{\tyenv}{\tyopen{\type}{\var}}
}

\infer{
% \signature\tyconstant = \kind
\wellsharedkindspine{\tyenv}{\erase\kind}{\spine}
}{
\wellsharedtype{\tyenv}{\tyapp{\tyconstant}{\spine}}
}
\end{mathpar}
\end{center}

\boxedtitle{
\wellsharedkindspine{\tyenv}{\prekind}{\adefs}
}
\begin{center}
\begin{mathpar}
\infer{
\wellsharedhead{\tyenv}{\head}{\promise_2}{\pretype'} \\\\
\promise_1 \leq \promise_2 \\
\subpretype{\pretype_1'}{\pretype_1}
}{
\wellsharedkindspine{\tyenv}
                    {\pkarrow{\pretype}{\promise_1}{\prekind}}
                    {\head\spine}
}

\infer{
}{
\wellsharedkindspine{\tyenv}{\pkconst}{\emptylist}
}
\end{mathpar}
\end{center}

\boxedtitle{
\subpretype{\pretype}{\pretype}
}
\begin{center}
\begin{mathpar}
\infer{
}{
\subpretype{\ptconst}{\ptconst}
}

\infer{
\promise \leq \promise' \\
\subpretype{\pretype_1'}{\pretype_1} \\
\subpretype{\pretype_2}{\pretype_2'} \\
}{
\subpretype{\ptarrow{\pretype_1}{\promise}{\pretype_2}} 
           {\ptarrow{\pretype_1'}{\promise'}{\pretype_2'}}
}
% FIXME: Rajouter transitivite et reflexivite?
\end{mathpar}
\end{center}

\caption{Well-formed sharing.}
\label{fig:well-shared}
\end{figure}
